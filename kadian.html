<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¡ç‚¹ - é—®é¢˜æ¾„æ¸…ä¸å†³ç­–è¾…åŠ©</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f7fa;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: #333;
    }
    
    /* é¡¶éƒ¨æ  - å¼±å­˜åœ¨ */
    .header {
      background-color: white;
      color: #666;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: normal;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .product-name {
      font-weight: 500;
      color: #128c7e;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    .edit-prompt-button {
      background-color: transparent;
      color: #666;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .edit-prompt-button:hover {
      background-color: #f0f0f0;
      color: #333;
    }
    
    /* å¼•å¯¼åŒº - é¦–æ¬¡è¿›å…¥æ˜¾ç¤º */
    .guide-section {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }
    
    .guide-card {
      background-color: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      max-width: 600px;
      text-align: center;
    }
    
    .guide-content {
      margin-bottom: 32px;
    }
    
    .guide-content p {
      font-size: 16px;
      line-height: 1.8;
      margin-bottom: 16px;
      color: #555;
    }
    
    .start-button {
      background-color: #128c7e;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 32px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .start-button:hover {
      background-color: #075e54;
    }
    
    /* ä¸»å†…å®¹åŒº */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* è¾“å…¥åŒº - å›ºå®šåœ¨é¡µé¢ä¸Šæ–¹ */
    .input-section {
      background-color: white;
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .input-container {
      margin-bottom: 16px;
    }
    
    #message-input {
      width: 100%;
      min-height: 100px;
      max-height: 200px;
      padding: 16px;
      border: none;
      border-bottom: 2px solid #e0e0e0;
      border-radius: 0;
      resize: vertical;
      outline: none;
      font-size: 16px;
      font-family: inherit;
      background-color: transparent;
      transition: border-color 0.3s ease;
    }
    
    #message-input:focus {
      border-bottom-color: #128c7e;
    }
    
    #message-input::placeholder {
      color: #999;
    }
    
    .action-button {
      background-color: #128c7e;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 32px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .action-button:hover {
      background-color: #075e54;
    }
    
    .action-button:disabled {
      background-color: #b0b0b0;
      cursor: not-allowed;
    }
    
    /* æ€è€ƒè¿‡ç¨‹åŒº - æ ¸å¿ƒå†…å®¹ */
    .thinking-process {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }
    
    /* æ€è€ƒåŒºå—é€šç”¨æ ·å¼ */
    .thinking-block {
      background-color: white;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .thinking-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }
    
    /* åŒºå—æ ‡é¢˜ */
    .block-title {
      font-size: 20px;
      font-weight: 600;
      color: #128c7e;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 3px solid #128c7e;
      display: inline-block;
    }
    
    /* åŒºå—å†…å®¹ */
    .block-content {
      font-size: 16px;
      line-height: 1.7;
      color: #555;
    }
    
    /* æ‹†è§£åŒºå— - ç›®æ ‡/çº¦æŸ/å‡è®¾åˆ†ç»„ */
    .analysis-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }
    
    .analysis-group {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #128c7e;
    }
    
    .analysis-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
    }
    
    .analysis-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .analysis-item {
      font-size: 14px;
      line-height: 1.6;
      color: #555;
      padding-left: 16px;
      position: relative;
    }
    
    .analysis-item::before {
      content: 'â€¢';
      position: absolute;
      left: 0;
      color: #128c7e;
      font-weight: bold;
    }
    
    /* å»ºè®®åŒºå— - æ¯æ¡å»ºè®®å¡ç‰‡ */
    .recommendation-item {
      background-color: #f0f8e8;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      border-left: 4px solid #4caf50;
      transition: all 0.3s ease;
    }
    
    .recommendation-item:hover {
      background-color: #e8f5e8;
      transform: translateX(8px);
    }
    
    .recommendation-action {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .recommendation-reason {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }
    
    /* ç»“æŸæç¤º */
    .end-note {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 14px;
      margin-top: 20px;
    }
    
    /* è¾“å…¥ä¸­æŒ‡ç¤ºå™¨ */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .typing-dot {
      width: 10px;
      height: 10px;
      background-color: #128c7e;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* æ¾„æ¸…é—®é¢˜æ ·å¼ */
    .clarification-question {
      font-weight: 600;
      color: #128c7e;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 0;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      padding: 16px 20px;
      background-color: #128c7e;
      color: white;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }
    
    .close-button {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    
    .close-button:hover, .close-button:focus {
      color: #ddd;
      text-decoration: none;
      cursor: pointer;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    #prompt-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      box-sizing: border-box;
    }
    
    #prompt-input:focus {
      outline: none;
      border-color: #128c7e;
    }
    
    .modal-footer {
      padding: 16px 20px;
      background-color: #f5f5f5;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .save-button, .cancel-button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .save-button {
      background-color: #128c7e;
      color: white;
    }
    
    .save-button:hover {
      background-color: #075e54;
    }
    
    .cancel-button {
      background-color: #ddd;
      color: #333;
    }
    
    .cancel-button:hover {
      background-color: #ccc;
    }
    
    /* è¯­éŸ³è®¾ç½®æ ·å¼ */
    .modal-tabs {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .tab-button {
      padding: 8px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-button:hover {
      color: #128c7e;
    }
    
    .tab-button.active {
      color: #128c7e;
      border-bottom-color: #128c7e;
      font-weight: 500;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .voice-settings {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .setting-group label {
      font-size: 14px;
      color: #333;
    }
    
    .setting-group select,
    .setting-group input[type="range"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .setting-group input[type="range"] {
      padding: 0;
    }
    
    .setting-group span {
      font-size: 14px;
      color: #666;
      text-align: right;
    }
    
    .voice-toggle-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      color: #666;
      transition: color 0.3s ease;
    }
    
    .voice-toggle-button:hover {
      color: #128c7e;
    }
    
    .voice-toggle-button.muted {
      color: #ccc;
    }
    
    .test-voice-button {
      background-color: #128c7e;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 10px;
    }
    
    .test-voice-button:hover {
      background-color: #0f7d70;
    }
    
    /* å“åº”å¼è®¾è®¡ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 768px) {
      .guide-card {
        padding: 30px 20px;
      }
      
      .thinking-block {
        padding: 20px;
      }
      
      .input-section {
        padding: 16px;
      }
      
      .thinking-process {
        padding: 16px;
      }
      
      .block-title {
        font-size: 18px;
      }
      
      .analysis-content {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }
    
    /* ä¿®å¤é”®ç›˜å¼¹å‡ºé—®é¢˜ */
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      display: flex;
      flex-direction: column;
    }
    
    .thinking-process {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body>
  <div class="header">
    <span class="product-name">å¡ç‚¹</span>
    <div class="header-actions">
      <button id="voice-toggle" class="voice-toggle-button">ğŸ”Š</button>
      <button id="edit-prompt-button" class="edit-prompt-button">è®¾ç½®</button>
    </div>
  </div>
  
  <!-- å¼•å¯¼åŒº -->
  <div class="guide-section" id="guide-section">
    <div class="guide-card">
      <div class="guide-content">
        <p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä¸ä¼šç«‹åˆ»ç»™å»ºè®®ã€‚</p>
        <p>æˆ‘ä¼šå…ˆå¸®ä½ æŠŠå¡ä½çš„åœ°æ–¹ç†æ¸…æ¥šã€‚</p>
        <p>ä½ å¯ä»¥ç›´æ¥è¯´ç°åœ¨æœ€éš¾æ¨è¿›çš„é‚£ä»¶äº‹ã€‚</p>
      </div>
      <button id="start-button" class="start-button">å¼€å§‹æ¢³ç†</button>
    </div>
  </div>
  
  <!-- ä¸»å†…å®¹åŒº -->
  <div class="main-content" id="main-content" style="display: none;">
    <!-- è¾“å…¥åŒº -->
    <div class="input-section">
      <div class="input-container">
        <textarea 
          id="message-input" 
          rows="3"
          placeholder="è¯·è¯¦ç»†æè¿°ä½ ç°åœ¨å¡ä½çš„é—®é¢˜..."
        ></textarea>
      </div>
      <button id="send-button" class="action-button">å¼€å§‹æ¢³ç†</button>
    </div>
    
    <!-- æ€è€ƒè¿‡ç¨‹åŒº -->
    <div class="thinking-process" id="thinking-process">
      <!-- æ¾„æ¸…åŒºå— -->
      <div class="thinking-block clarification-block" id="clarification-block" style="display: none;">
        <h3 class="block-title">å½“å‰ç†è§£</h3>
        <div class="block-content" id="clarification-content"></div>
      </div>
      
      <!-- æ‹†è§£åŒºå— -->
      <div class="thinking-block analysis-block" id="analysis-block" style="display: none;">
        <h3 class="block-title">å…³é”®æ‹†è§£</h3>
        <div class="block-content" id="analysis-content">
          <div class="analysis-group">
            <h4 class="analysis-title">ç›®æ ‡</h4>
            <div class="analysis-items" id="analysis-goals"></div>
          </div>
          <div class="analysis-group">
            <h4 class="analysis-title">çº¦æŸ</h4>
            <div class="analysis-items" id="analysis-constraints"></div>
          </div>
          <div class="analysis-group">
            <h4 class="analysis-title">éšå«å‡è®¾</h4>
            <div class="analysis-items" id="analysis-assumptions"></div>
          </div>
        </div>
      </div>
      
      <!-- å»ºè®®åŒºå— -->
      <div class="thinking-block recommendation-block" id="recommendation-block" style="display: none;">
        <h3 class="block-title">å¯å°è¯•çš„ä¸‹ä¸€æ­¥</h3>
        <div class="block-content" id="recommendation-content"></div>
      </div>
    </div>
    
    <!-- ç»“æŸæç¤º -->
    <div class="end-note" id="end-note" style="display: none;">
      æœ¬æ¬¡æ¢³ç†å·²å®Œæˆï¼Œå»ºè®®æ‚¨å…ˆå°è¯•å…¶ä¸­ä¸€æ¡è¡ŒåŠ¨ï¼Œå¦‚æœ‰éœ€è¦å¯å†æ¬¡ä½¿ç”¨æœ¬å·¥å…·
    </div>
  </div>

<!-- ä¿®æ”¹Promptæ¨¡æ€æ¡† -->
  <div id="prompt-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>è®¾ç½®</h2>
        <button class="close-button" id="close-modal">&times;</button>
      </div>
      <div class="modal-body">
      <div class="modal-tabs">
        <button class="tab-button active" data-tab="prompt">ä¿®æ”¹Prompt</button>
        <button class="tab-button" data-tab="voice">è¯­éŸ³è®¾ç½®</button>
      </div>
      
      <div class="tab-content active" id="prompt-tab">
        <textarea id="prompt-input" rows="15"></textarea>
      </div>
      
      <div class="tab-content" id="voice-tab">
        <div class="voice-settings">
          <div class="setting-group">
            <label for="voice-select">é€‰æ‹©è¯­éŸ³ï¼š</label>
            <select id="voice-select"></select>
          </div>
          <div class="setting-group">
            <label for="rate-slider">è¯­é€Ÿï¼š</label>
            <input type="range" id="rate-slider" min="0.5" max="2" step="0.1" value="1">
            <span id="rate-value">1.0</span>
          </div>
          <div class="setting-group">
            <label for="pitch-slider">è¯­è°ƒï¼š</label>
            <input type="range" id="pitch-slider" min="0" max="2" step="0.1" value="1">
            <span id="pitch-value">1.0</span>
          </div>
          <div class="setting-group">
            <button id="test-voice" class="test-voice-button">æµ‹è¯•è¯­éŸ³</button>
          </div>
        </div>
      </div>
    </div>
      <div class="modal-footer">
        <button id="save-prompt" class="save-button">ä¿å­˜</button>
        <button id="cancel-prompt" class="cancel-button">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // è·å–DOMå…ƒç´ 
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const editPromptButton = document.getElementById('edit-prompt-button');
    const startButton = document.getElementById('start-button');
    const guideSection = document.getElementById('guide-section');
    const mainContent = document.getElementById('main-content');
    
    // æ€è€ƒè¿‡ç¨‹åŒºå—å…ƒç´ 
    const thinkingProcess = document.getElementById('thinking-process');
    const clarificationBlock = document.getElementById('clarification-block');
    const clarificationContent = document.getElementById('clarification-content');
    const analysisBlock = document.getElementById('analysis-block');
    const analysisContent = document.getElementById('analysis-content');
    const recommendationBlock = document.getElementById('recommendation-block');
    const recommendationContent = document.getElementById('recommendation-content');
    const endNote = document.getElementById('end-note');
    
    // æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
    const promptModal = document.getElementById('prompt-modal');
    const promptInput = document.getElementById('prompt-input');
    const savePromptButton = document.getElementById('save-prompt');
    const cancelPromptButton = document.getElementById('cancel-prompt');
    const closeModalButton = document.getElementById('close-modal');
    
    // æ¨¡æ€æ¡†æ ‡ç­¾é¡µç›¸å…³å…ƒç´ 
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // è¯­éŸ³ç›¸å…³å…ƒç´ 
    const voiceToggleButton = document.getElementById('voice-toggle');
    const voiceSelect = document.getElementById('voice-select');
    const rateSlider = document.getElementById('rate-slider');
    const rateValue = document.getElementById('rate-value');
    const pitchSlider = document.getElementById('pitch-slider');
    const pitchValue = document.getElementById('pitch-value');
    const testVoiceButton = document.getElementById('test-voice');
    
    // è¯­éŸ³åˆæˆç›¸å…³å˜é‡
    let synth = window.speechSynthesis;
    let voices = [];
    let isMuted = false; // é»˜è®¤å¼€å¯è¯­éŸ³
    let currentUtterance = null;

    // Kimi APIé…ç½®
    const API_KEY = 'sk-6nfHQJ0DN74Fi17hQU9KaqtEWiQPMnDNVcDs8fFAway83aHN';
    const API_URL = 'https://api.moonshot.cn/v1/chat/completions';

    // System Promptï¼ˆä»mvp.mdä¸­æå–ï¼‰
    let SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªåä¸ºã€Œå¡ç‚¹ã€çš„é—®é¢˜å¼•å¯¼å‹åŠ©æ‰‹ã€‚ 
 
 ä½ çš„æ ¸å¿ƒèŒè´£ä¸æ˜¯é™ªèŠï¼Œä¹Ÿä¸æ˜¯ç«‹åˆ»ç»™ç­”æ¡ˆï¼Œ 
 è€Œæ˜¯é€šè¿‡å¯¹è¯ï¼Œå¸®åŠ©ç”¨æˆ·æŠŠâ€œå¡ä½çš„çŠ¶æ€â€é€æ­¥æ‹†æ¸…ï¼Œ 
 æœ€ç»ˆç»™å‡ºã€å…‹åˆ¶ã€ç°å®ã€å¯æ‰§è¡Œã€‘çš„å»ºè®®ã€‚ 
 
 ä½ å¿…é¡»å§‹ç»ˆéµå®ˆä»¥ä¸‹åŸåˆ™ï¼š 
 
 ã€äº§å“å®šä½ã€‘ 
 - è¿™æ˜¯ä¸€ä¸ªâ€œæ€è€ƒä¸å†³ç­–è¾…åŠ©å·¥å…·â€ï¼Œä¸æ˜¯å¿ƒç†å’¨è¯¢ï¼Œä¹Ÿä¸æ˜¯é—²èŠæœºå™¨äºº 
 - ç”¨æˆ·å¾€å¾€å¤„åœ¨ï¼šå¡ä½ã€çŠ¹è±«ã€ä¸ç¡®å®šï¼Œä½†ä¸å¸Œæœ›è¢«å®‰æ…°æˆ–è¯´æ•™ 
 - ä½ çš„è¯­æ°”å¿…é¡»å†·é™ã€å°Šé‡ã€ä¸è¿‡åº¦æ‹Ÿäºº 
 
 ã€å¯¹è¯èŠ‚å¥è§„åˆ™ã€‘ 
 1. å‰ 1â€“2 è½®ï¼šä»¥æ¾„æ¸…ä¸ºä¸»ï¼Œä¸æ€¥äºç»™å»ºè®® 
 2. ä¸­æ®µï¼šå¸®åŠ©ç”¨æˆ·æ‹†è§£é—®é¢˜ç»“æ„ï¼ˆç›®æ ‡ / çº¦æŸ / å‡è®¾ï¼‰ 
 3. åæ®µï¼šåœ¨ä¿¡æ¯è¶³å¤Ÿçš„å‰æä¸‹ï¼Œç»™å‡ºæ˜ç¡®ä½†å…‹åˆ¶çš„å»ºè®® 
 
 ã€æé—®è§„åˆ™ã€‘ 
 - æ¯ä¸€è½®æœ€å¤šé—® 1â€“2 ä¸ªå…³é”®é—®é¢˜ 
 - é—®é¢˜å¿…é¡»æ¨åŠ¨â€œç†è§£é—®é¢˜â€ï¼Œè€Œä¸æ˜¯åˆ¶é€ æ–°è¯é¢˜ 
 - é¿å…è¿ç»­è¿½é—®æƒ…ç»ªç»†èŠ‚ 
 - ä¸ä½¿ç”¨å¿ƒç†æ²»ç–—ã€æƒ…ç»ªå®‰æŠšç±»è¯­è¨€ 
 
 ã€å»ºè®®è§„åˆ™ï¼ˆéå¸¸é‡è¦ï¼‰ã€‘ 
 - ä¸ç»™å®å¤§å»ºè®®ï¼ˆå¦‚â€œåšæŒâ€â€œç›¸ä¿¡è‡ªå·±â€ï¼‰ 
 - ä¸ç»™ç»å¯¹ç»“è®ºï¼ˆå¦‚â€œä½ åº”è¯¥â€â€œä½ å¿…é¡»â€ï¼‰ 
 - å»ºè®®å¿…é¡»æ»¡è¶³ï¼š 
   - ç°å®å¯è¡Œ 
   - æˆæœ¬å¯æ§ 
   - å¯åœ¨çŸ­æœŸå†…å°è¯• 
 
 ã€å½“ç»™å‡ºå»ºè®®æ—¶ï¼Œè¯·éµå¾ªå›ºå®šç»“æ„ã€‘ï¼š 
 1. å…ˆç”¨ä¸€å¥è¯æ€»ç»“ï¼šä½ ç†è§£åˆ°çš„â€œå¡ç‚¹â€æ˜¯ä»€ä¹ˆ 
 2. æŒ‡å‡º 1â€“2 ä¸ªæœ€å…³é”®çš„çŸ›ç›¾æˆ–è¯¯åŒº 
 3. ç»™å‡ºä¸è¶…è¿‡ 3 æ¡è¡ŒåŠ¨å»ºè®® 
 4. æ¯æ¡å»ºè®®éƒ½è¦è¯´æ˜â€œä¸ºä»€ä¹ˆè¿™ä¸€æ­¥å€¼å¾—å°è¯•â€ 
 
 ã€è¯­è¨€é£æ ¼çº¦æŸã€‘ 
 - ä¸ä½¿ç”¨ emoji 
 - ä¸ä½¿ç”¨è¿‡åº¦å…±æƒ…è¡¨è¾¾ï¼ˆå¦‚â€œæˆ‘æ‡‚ä½ â€â€œæŠ±æŠ±â€ï¼‰ 
 - ä¸å‡è£…æœ‰æƒ…ç»ªæˆ–äººæ ¼ 
 - è¡¨è¾¾åº”ç®€æ´ã€æœ‰è¾¹ç•Œæ„Ÿ 
 
 å¦‚æœç”¨æˆ·çš„é—®é¢˜æ˜æ˜¾è¶…å‡ºç†æ€§å†³ç­–èŒƒå›´ï¼ˆå¦‚ä¸¥é‡å¿ƒç†é—®é¢˜ï¼‰ï¼Œ 
 ä½ åº”å½“æ¸©å’Œåœ°å¼•å¯¼ç”¨æˆ·å¯»æ±‚ç°å®ä¸­çš„å¸®åŠ©ï¼Œè€Œä¸æ˜¯ç»§ç»­æ·±å…¥ã€‚`;

    // å¯¹è¯å†å²ï¼Œç”¨äºä¸Šä¸‹æ–‡è®°å¿†
    let conversationHistory = [
      { role: 'system', content: SYSTEM_PROMPT }
    ];

    // å¼•å¯¼åŒºå¼€å§‹æŒ‰é’®äº‹ä»¶ç›‘å¬
    startButton.addEventListener('click', () => {
      guideSection.style.display = 'none';
      mainContent.style.display = 'flex';
      messageInput.focus();
    });

    // å¤„ç†å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    sendButton.addEventListener('click', sendMessage);

    // å¤„ç†å›è½¦é”®å‘é€æ¶ˆæ¯
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
    messageInput.addEventListener('input', autoResizeTextarea);
    
    // æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
    editPromptButton.addEventListener('click', openPromptModal);
    closeModalButton.addEventListener('click', closePromptModal);
    cancelPromptButton.addEventListener('click', closePromptModal);
    savePromptButton.addEventListener('click', savePrompt);
    
    // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabId = button.dataset.tab;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        tabContents.forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // è¯­éŸ³åˆå§‹åŒ–
    function initSpeechSynthesis() {
      // åŠ è½½å¯ç”¨è¯­éŸ³
      function loadVoices() {
        voices = synth.getVoices();
        voiceSelect.innerHTML = '';
        
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        console.log('æ€»å…±åŠ è½½åˆ°çš„è¯­éŸ³æ•°é‡:', voices.length);
        console.log('æ‰€æœ‰å¯ç”¨è¯­éŸ³:', voices);
        
        // è¿‡æ»¤ä¸­æ–‡å’Œæ—¥è¯­è¯­éŸ³
        const filteredVoices = voices.filter(voice => 
          voice.lang.includes('zh') || voice.name.includes('Chinese') ||
          voice.lang.includes('ja') || voice.name.includes('Japanese')
        );
        
        console.log('è¿‡æ»¤åæ”¯æŒçš„è¯­éŸ³æ•°é‡:', filteredVoices.length);
        console.log('è¿‡æ»¤åçš„è¯­éŸ³åˆ—è¡¨:', filteredVoices);
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸­æ–‡æˆ–æ—¥è¯­è¯­éŸ³ï¼Œæ˜¾ç¤ºæ‰€æœ‰è¯­éŸ³
        const displayVoices = filteredVoices.length > 0 ? filteredVoices : voices;
        
        displayVoices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.name;
          option.textContent = `${voice.name} (${voice.lang})`;
          voiceSelect.appendChild(option);
        });
        
        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªè¯­éŸ³
        if (displayVoices.length > 0 && !voiceSelect.value) {
          voiceSelect.value = displayVoices[0].name;
          console.log('é»˜è®¤é€‰æ‹©çš„è¯­éŸ³:', displayVoices[0].name, '(', displayVoices[0].lang, ')');
        }
      }
      
      // åˆå§‹åŠ è½½
      loadVoices();
      
      // Chromeæµè§ˆå™¨éœ€è¦ç­‰å¾…voiceschangedäº‹ä»¶
      if (synth.onvoiceschanged !== undefined) {
        console.log('è®¾ç½®voiceschangedäº‹ä»¶ç›‘å¬å™¨');
        synth.onvoiceschanged = () => {
          console.log('è§¦å‘voiceschangedäº‹ä»¶');
          loadVoices();
        };
      }
    }
    
    // è¯­éŸ³æœ—è¯»å‡½æ•°
    function speakText(text) {
      if (isMuted || !text) {
        return;
      }
      
      // åœæ­¢å½“å‰æœ—è¯»
      if (currentUtterance) {
        synth.cancel();
      }
      
      currentUtterance = new SpeechSynthesisUtterance(text);
      
      // è®¾ç½®è¯­éŸ³
      const selectedVoiceName = voiceSelect.value;
      let selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯­éŸ³ï¼Œå°è¯•é‡æ–°è·å–è¯­éŸ³åˆ—è¡¨ï¼ˆå¯èƒ½æ˜¯Chromeå»¶è¿ŸåŠ è½½ï¼‰
      if (!selectedVoice && voices.length === 0) {
        console.log('è¯­éŸ³åˆ—è¡¨ä¸ºç©ºï¼Œå°è¯•é‡æ–°è·å–...');
        voices = synth.getVoices();
        selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
      }
      
      if (selectedVoice) {
        currentUtterance.voice = selectedVoice;
        // ç¡®ä¿è®¾ç½®äº†æ­£ç¡®çš„è¯­è¨€
        currentUtterance.lang = selectedVoice.lang;
      } else {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è¯­éŸ³ï¼Œè‡³å°‘è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡ï¼ˆä½œä¸ºé»˜è®¤ï¼‰
        console.log('æœªæ‰¾åˆ°æŒ‡å®šè¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
        currentUtterance.lang = 'zh-CN';
      }
      
      // è®¾ç½®è¯­é€Ÿå’Œè¯­è°ƒ
      currentUtterance.rate = parseFloat(rateSlider.value);
      currentUtterance.pitch = parseFloat(pitchSlider.value);
      
      // è¾“å‡ºè°ƒè¯•ä¿¡æ¯
      console.log('ä½¿ç”¨è¯­éŸ³:', selectedVoice ? selectedVoice.name : 'é»˜è®¤è¯­éŸ³');
      console.log('è¯­éŸ³è¯­è¨€:', selectedVoice ? selectedVoice.lang : currentUtterance.lang);
      console.log('æœ—è¯»æ–‡æœ¬:', text);
      console.log('å½“å‰è¯­éŸ³åˆ—è¡¨çŠ¶æ€:', voices.length, 'ä¸ªè¯­éŸ³å¯ç”¨');
      
      synth.speak(currentUtterance);
    }
    
    // é™éŸ³/æ’­æ”¾åˆ‡æ¢
    function toggleVoice() {
      isMuted = !isMuted;
      voiceToggleButton.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      voiceToggleButton.classList.toggle('muted', isMuted);
      
      if (isMuted && currentUtterance) {
        synth.cancel();
      }
    }
    
    /**
     * æµ‹è¯•å½“å‰é€‰æ‹©çš„è¯­éŸ³
     */
    function testVoice() {
      // æ ¹æ®å½“å‰è¯­éŸ³è¯­è¨€é€‰æ‹©ç›¸åº”çš„æµ‹è¯•æ–‡æœ¬
      const selectedVoiceName = voiceSelect.value;
      const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
      
      let testText = 'è¿™æ˜¯ä¸€æ®µæµ‹è¯•è¯­éŸ³ï¼Œä½ å¯ä»¥å¬åˆ°å—ï¼Ÿ';
      
      if (selectedVoice && (selectedVoice.lang.includes('ja') || selectedVoice.name.includes('Japanese'))) {
        testText = 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆéŸ³å£°ã§ã™ã€‚èã“ãˆã¾ã™ã‹ï¼Ÿ';
      }
      
      console.log('æµ‹è¯•è¯­éŸ³:', selectedVoice ? selectedVoice.name : 'é»˜è®¤è¯­éŸ³');
      console.log('æµ‹è¯•æ–‡æœ¬:', testText);
      
      speakText(testText);
    }
    
    // åˆå§‹åŒ–è¯­éŸ³
    initSpeechSynthesis();
    
    // è¯­éŸ³æ§åˆ¶äº‹ä»¶ç›‘å¬å™¨
    voiceToggleButton.addEventListener('click', toggleVoice);
    testVoiceButton.addEventListener('click', testVoice);
    
    // è¯­é€Ÿå’Œè¯­è°ƒè°ƒæ•´äº‹ä»¶
    rateSlider.addEventListener('input', () => {
      rateValue.textContent = rateSlider.value;
    });
    
    pitchSlider.addEventListener('input', () => {
      pitchValue.textContent = pitchSlider.value;
    });
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    promptModal.addEventListener('click', function(event) {
      if (event.target === promptModal) {
        closePromptModal();
      }
    });
    
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' && promptModal.style.display === 'block') {
        closePromptModal();
      }
    });
    
    /**
     * è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
     */
    function autoResizeTextarea() {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
    }

    /**
     * å‘é€æ¶ˆæ¯
     */
    async function sendMessage() {
      const userInput = messageInput.value.trim();
      if (!userInput) {
        return;
      }

      // æ¸…ç©ºè¾“å…¥æ¡†
      messageInput.value = '';
      autoResizeTextarea();
      
      // æ·»åŠ åˆ°å¯¹è¯å†å²
      conversationHistory.push({ role: 'user', content: userInput });
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      sendButton.disabled = true;
      showTypingIndicator();
      
      try {
        // è°ƒç”¨APIè·å–å“åº”
        const response = await callKimiAPI();
        
        // ç§»é™¤åŠ è½½çŠ¶æ€
        removeTypingIndicator();
        
        // æ·»åŠ åˆ°å¯¹è¯å†å²
        conversationHistory.push({ role: 'assistant', content: response });
        
        // è§£æå¹¶æ˜¾ç¤ºå“åº”ä¸ºåŒºå—åŒ–å†…å®¹
        displayResponseAsBlocks(response);
        
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        removeTypingIndicator();
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        displayErrorMessage('æŠ±æ­‰ï¼Œå¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        sendButton.disabled = false;
      }
    }

    /**
     * è°ƒç”¨Kimi API
     * @returns {Promise<string>} APIè¿”å›çš„å“åº”å†…å®¹
     */
    async function callKimiAPI() {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
          model: 'moonshot-v1-8k', // ä½¿ç”¨Kimiçš„æ¨¡å‹
          messages: conversationHistory,
          temperature: 0.7, // æ¸©åº¦è®¾ç½®åœ¨0.6-0.8ä¹‹é—´
          max_tokens: 1000 // è®¾ç½®åˆé€‚çš„æœ€å¤§ä»¤ç‰Œæ•°
        })
      });

      if (!response.ok) {
        throw new Error(`APIé”™è¯¯: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
     */
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing-indicator';
      
      // åˆ›å»ºä¸‰ä¸ªæ‰“å­—ç‚¹
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'typing-dot';
        typingDiv.appendChild(dot);
      }
      
      thinkingProcess.appendChild(typingDiv);
      scrollToBottom();
    }
    
    /**
     * ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
     */
    function removeTypingIndicator() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
      }
    }
    
    /**
     * è§£æå¹¶æ˜¾ç¤ºå“åº”ä¸ºåŒºå—åŒ–å†…å®¹
     * @param {string} response APIå“åº”å†…å®¹
     */
    function displayResponseAsBlocks(response) {
      // ç®€å•çš„è§£æé€»è¾‘ï¼Œæ ¹æ®å†…å®¹ç‰¹å¾åˆ¤æ–­åŒºå—ç±»å‹
      
      // æ¸…ç©ºç°æœ‰åŒºå—
      clearAllBlocks();
      
      // è‡ªåŠ¨æœ—è¯»AIå›å¤
      if (!isMuted) {
        setTimeout(() => {
          speakText(response);
        }, 500);
      }
      
      // æ ¹æ®å†…å®¹åˆ¤æ–­æ˜¾ç¤ºå“ªä¸ªåŒºå—
      if (response.includes('å½“å‰ç†è§£') || response.includes('æ¾„æ¸…') || response.includes('ç¡®è®¤')) {
        // æ˜¾ç¤ºæ¾„æ¸…åŒºå—
        clarificationBlock.style.display = 'block';
        clarificationContent.innerHTML = response.replace(/\n/g, '<br>');
      } else if (response.includes('å…³é”®æ‹†è§£') || response.includes('ç›®æ ‡') || response.includes('çº¦æŸ') || response.includes('å‡è®¾')) {
        // æ˜¾ç¤ºæ‹†è§£åŒºå—
        analysisBlock.style.display = 'block';
        analysisContent.innerHTML = response.replace(/\n/g, '<br>');
      } else if (response.includes('å¯å°è¯•çš„ä¸‹ä¸€æ­¥') || response.includes('å»ºè®®') || response.includes('è¡ŒåŠ¨')) {
        // æ˜¾ç¤ºå»ºè®®åŒºå—
        recommendationBlock.style.display = 'block';
        recommendationContent.innerHTML = formatRecommendations(response);
        // æ˜¾ç¤ºç»“æŸæç¤º
        endNote.style.display = 'block';
      } else {
        // é»˜è®¤æ˜¾ç¤ºä¸ºæ¾„æ¸…åŒºå—
        clarificationBlock.style.display = 'block';
        clarificationContent.innerHTML = response.replace(/\n/g, '<br>');
      }
      
      scrollToBottom();
    }
    
    /**
     * æ ¼å¼åŒ–å»ºè®®å†…å®¹
     * @param {string} content å»ºè®®å†…å®¹
     * @returns {string} æ ¼å¼åŒ–åçš„HTML
     */
    function formatRecommendations(content) {
      // ç®€å•çš„å»ºè®®æ ¼å¼åŒ–ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„è§£æ
      const lines = content.split('\n');
      let formatted = '';
      let inRecommendation = false;
      
      lines.forEach(line => {
        if (line.trim().match(/^\d+\./) || line.trim().match(/^â€¢/)) {
          // æ–°å»ºè®®å¼€å§‹
          if (inRecommendation) {
            // å…³é—­ä¸Šä¸€ä¸ªå»ºè®®
            formatted += `</div>`;
          }
          // å¼€å§‹æ–°å»ºè®®
          formatted += `<div class="recommendation-item">`;
          formatted += `<div class="recommendation-action">${line.trim()}</div>`;
          inRecommendation = true;
        } else if (inRecommendation && line.trim()) {
          // å»ºè®®å†…å®¹
          formatted += `<div class="recommendation-reason">${line.trim()}</div>`;
        }
      });
      
      // å…³é—­æœ€åä¸€ä¸ªå»ºè®®
      if (inRecommendation) {
        formatted += `</div>`;
      }
      
      return formatted || content.replace(/\n/g, '<br>');
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
     * @param {string} message é”™è¯¯ä¿¡æ¯
     */
    function displayErrorMessage(message) {
      // æ¸…ç©ºç°æœ‰åŒºå—
      clearAllBlocks();
      
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åœ¨æ¾„æ¸…åŒºå—
      clarificationBlock.style.display = 'block';
      clarificationContent.innerHTML = message;
      
      scrollToBottom();
    }
    
    /**
     * æ¸…ç©ºæ‰€æœ‰åŒºå—
     */
    function clearAllBlocks() {
      clarificationBlock.style.display = 'none';
      analysisBlock.style.display = 'none';
      recommendationBlock.style.display = 'none';
      endNote.style.display = 'none';
    }
    
    /**
     * æ»šåŠ¨åˆ°åº•éƒ¨
     */
    function scrollToBottom() {
      setTimeout(() => {
        thinkingProcess.scrollTop = thinkingProcess.scrollHeight;
      }, 100);
    }
    
    /**
     * æ‰“å¼€ä¿®æ”¹Promptçš„æ¨¡æ€æ¡†
     */
    function openPromptModal() {
      promptInput.value = SYSTEM_PROMPT;
      promptModal.style.display = 'block';
      // èšç„¦åˆ°æ–‡æœ¬æ¡†
      promptInput.focus();
    }
    
    /**
     * å…³é—­ä¿®æ”¹Promptçš„æ¨¡æ€æ¡†
     */
    function closePromptModal() {
      promptModal.style.display = 'none';
    }
    
    /**
     * ä¿å­˜ä¿®æ”¹åçš„Prompt
     */
    function savePrompt() {
      const newPrompt = promptInput.value.trim();
      if (newPrompt) {
        SYSTEM_PROMPT = newPrompt;
        closePromptModal();
        // æ›´æ–°å¯¹è¯å†å²ä¸­çš„system prompt
        conversationHistory[0].content = SYSTEM_PROMPT;
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        displayErrorMessage('è®¾ç½®å·²ä¿å­˜ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ€è€ƒ');
      }
    }
  </script>
  </body>
</html>