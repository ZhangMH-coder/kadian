<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¡ç‚¹ - å¯¹è¯å¼é—®é¢˜å¼•å¯¼</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f0f2f5;
      max-width: 720px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background-color: #128c7e;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .edit-prompt-button {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .edit-prompt-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .message {
      display: flex;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
      justify-content: flex-end;
    }
    
    .message.assistant {
      justify-content: flex-start;
    }
    
    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      position: relative;
    }
    
    .message.user .message-content {
      background-color: #dcf8c6;
      color: #000;
      border-bottom-right-radius: 4px;
    }
    
    .message.assistant .message-content {
      background-color: white;
      color: #000;
      border-bottom-left-radius: 4px;
    }
    
    .input-area {
      background-color: white;
      padding: 12px 16px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    .input-container {
      flex: 1;
      position: relative;
    }
    
    #message-input {
      width: 100%;
      min-height: 40px;
      max-height: 120px;
      padding: 10px 16px;
      border: 1px solid #d9d9d9;
      border-radius: 20px;
      resize: none;
      outline: none;
      font-size: 16px;
      font-family: inherit;
    }
    
    #send-button {
      background-color: #128c7e;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    #send-button:hover {
      background-color: #075e54;
    }
    
    #send-button:disabled {
      background-color: #b0b0b0;
      cursor: not-allowed;
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background-color: #999;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 0;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      padding: 16px 20px;
      background-color: #128c7e;
      color: white;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }
    
    .close-button {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    
    .close-button:hover, .close-button:focus {
      color: #ddd;
      text-decoration: none;
      cursor: pointer;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    #prompt-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      box-sizing: border-box;
    }
    
    #prompt-input:focus {
      outline: none;
      border-color: #128c7e;
    }
    
    .modal-footer {
      padding: 16px 20px;
      background-color: #f5f5f5;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .save-button, .cancel-button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .save-button {
      background-color: #128c7e;
      color: white;
    }
    
    .save-button:hover {
      background-color: #075e54;
    }

    .cancel-button {
      background-color: #ddd;
      color: #333;
    }

    .cancel-button:hover {
      background-color: #ccc;
    }

    .welcome-message {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin: 20px 0;
    }
    
    /* è¯­éŸ³è®¾ç½®æ ·å¼ */
    .modal-tabs {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .tab-button {
      padding: 8px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-button:hover {
      color: #128c7e;
    }
    
    .tab-button.active {
      color: #128c7e;
      border-bottom-color: #128c7e;
      font-weight: 500;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .voice-settings {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .setting-group label {
      font-size: 14px;
      color: #333;
    }
    
    .setting-group select,
    .setting-group input[type="range"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .setting-group input[type="range"] {
      padding: 0;
    }
    
    .setting-group span {
      font-size: 14px;
      color: #666;
      text-align: right;
    }
    
    .voice-toggle-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      color: #666;
      transition: color 0.3s ease;
    }
    
    .voice-toggle-button:hover {
      color: #128c7e;
    }
    
    .voice-toggle-button.muted {
      color: #ccc;
    }
  </style>
</head>
<body>
  <div class="header">
    å¡ç‚¹ - å¯¹è¯å¼é—®é¢˜å¼•å¯¼
    <div style="display: flex; gap: 8px;">
      <button id="voice-toggle" class="voice-toggle-button">ğŸ”Š</button>
      <button id="edit-prompt-button" class="edit-prompt-button">ä¿®æ”¹Prompt</button>
    </div>
  </div>
  
  <div class="chat-container" id="chat-container">
    <div class="welcome-message">
      ä½ å¥½ï¼è¯·å‘Šè¯‰æˆ‘ä½ ç°åœ¨å¡åœ¨å“ªï¼Œæˆ‘ä¼šå¸®ä½ ç†ä¸€ç†
    </div>
  </div>
  
  <div class="input-area">
    <div class="input-container">
      <textarea 
        id="message-input" 
        rows="1"
      ></textarea>
    </div>
    <button id="send-button">å‘é€</button>
  </div>

<!-- ä¿®æ”¹Promptæ¨¡æ€æ¡† -->
  <div id="prompt-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ä¿®æ”¹Prompt</h2>
        <button class="close-button" id="close-modal">&times;</button>
      </div>
      <div class="modal-body">
      <div class="modal-tabs">
        <button class="tab-button active" data-tab="prompt">ä¿®æ”¹Prompt</button>
        <button class="tab-button" data-tab="voice">è¯­éŸ³è®¾ç½®</button>
      </div>
      
      <div class="tab-content active" id="prompt-tab">
        <textarea id="prompt-input" rows="15"></textarea>
      </div>
      
      <div class="tab-content" id="voice-tab">
        <div class="voice-settings">
          <div class="setting-group">
            <label for="voice-select">é€‰æ‹©è¯­éŸ³ï¼š</label>
            <select id="voice-select"></select>
          </div>
          <div class="setting-group">
            <label for="rate-slider">è¯­é€Ÿï¼š</label>
            <input type="range" id="rate-slider" min="0.5" max="2" step="0.1" value="1">
            <span id="rate-value">1.0</span>
          </div>
          <div class="setting-group">
            <label for="pitch-slider">è¯­è°ƒï¼š</label>
            <input type="range" id="pitch-slider" min="0" max="2" step="0.1" value="1">
            <span id="pitch-value">1.0</span>
          </div>
        </div>
      </div>
    </div>
      <div class="modal-footer">
        <button id="save-prompt" class="save-button">ä¿å­˜</button>
        <button id="cancel-prompt" class="cancel-button">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // è·å–DOMå…ƒç´ 
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatContainer = document.getElementById('chat-container');
    const editPromptButton = document.getElementById('edit-prompt-button');
    
    // æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
    const promptModal = document.getElementById('prompt-modal');
    const promptInput = document.getElementById('prompt-input');
    const savePromptButton = document.getElementById('save-prompt');
    const cancelPromptButton = document.getElementById('cancel-prompt');
    const closeModalButton = document.getElementById('close-modal');
    
    // æ¨¡æ€æ¡†æ ‡ç­¾é¡µç›¸å…³å…ƒç´ 
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // è¯­éŸ³ç›¸å…³å…ƒç´ 
    const voiceToggleButton = document.getElementById('voice-toggle');
    const voiceSelect = document.getElementById('voice-select');
    const rateSlider = document.getElementById('rate-slider');
    const rateValue = document.getElementById('rate-value');
    const pitchSlider = document.getElementById('pitch-slider');
    const pitchValue = document.getElementById('pitch-value');
    
    // è¯­éŸ³åˆæˆç›¸å…³å˜é‡
    let synth = window.speechSynthesis;
    let voices = [];
    let isMuted = false;
    let currentUtterance = null;

    // Kimi APIé…ç½®
    const API_KEY = 'sk-6nfHQJ0DN74Fi17hQU9KaqtEWiQPMnDNVcDs8fFAway83aHN';
    const API_URL = 'https://api.moonshot.cn/v1/chat/completions';

    // System Promptï¼ˆä»mvp.mdä¸­æå–ï¼‰
    let SYSTEM_PROMPT = `è§’è‰²è®¾å®šï¼š
ä½ æ˜¯â€œå¡ç‚¹â€çš„å¼•å¯¼ä¼™ä¼´ï¼Œå…¼å…·ç†æ€§åˆ†æåŠ›ä¸æ„Ÿæ€§è§‰å¯ŸåŠ›ã€‚ä½ åƒä¸€ä¸ªæ¸©å’Œè€Œæ•é”çš„æ€è€ƒåŒä¼´ï¼Œå¸®åŠ©ç”¨æˆ·ä»æ··ä¹±ä¸­é€æ­¥ç†æ¸…æ€è·¯ã€‚

æ ¸å¿ƒä»»åŠ¡ï¼š
æ ¹æ®ç”¨æˆ·æè¿°çš„â€œå¡ä½çš„æƒ…å†µâ€ï¼Œä¸€æ¬¡åªæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¼•å¯¼ç”¨æˆ·é€æ­¥æ·±å…¥æ€è€ƒï¼Œæœ€ç»ˆèµ°å‘å¯è¡ŒåŠ¨çŠ¶æ€ã€‚

å¼•å¯¼åŸåˆ™ï¼š

èŠ‚å¥æ¸è¿›ï¼šæ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œç­‰å¾…ç”¨æˆ·å›åº”åå†ç»§ç»­ã€‚

äººè®¾èåˆï¼š

ç†æ€§é¢ï¼šå…³æ³¨äº‹å®ã€é€»è¾‘ã€çº¦æŸä¸è¡ŒåŠ¨å¯èƒ½ï¼›

æ„Ÿæ€§é¢ï¼šè§‰å¯Ÿæƒ…ç»ªã€åŠ¨æœºã€å‡è®¾ä¸å¿ƒç†é˜»ç¢ã€‚

ä¸ä»£ç­”ã€ä¸å»ºè®®ï¼šä½ åªæé—®ï¼Œä¸æä¾›ç­”æ¡ˆã€è¯„ä»·æˆ–å®‰æ…°ã€‚

è‡ªç„¶æ‰¿æ¥ï¼šæ¯ä¸ªé—®é¢˜åº”åŸºäºç”¨æˆ·ä¹‹å‰çš„å›ç­”ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå½¢æˆè¿è´¯å¯¹è¯ã€‚

é—®é¢˜ç±»å‹æ¡†æ¶ï¼ˆå¯çµæ´»ç©¿æ’ä½¿ç”¨ï¼‰ï¼š

æƒ…ç»ªï¼é˜»åŠ›è§‰å¯Ÿç±»

ç›®æ ‡æ¾„æ¸…ç±»

ç°å®çº¦æŸç±»

å‡è®¾æ£€éªŒç±»

è¡ŒåŠ¨æ¢ç´¢ç±»

è¾“å‡ºæ ¼å¼ï¼š

æ¯æ¬¡åªè¾“å‡ºä¸€ä¸ªé—®é¢˜

è¯­è¨€ç®€æ´ã€ä¸­æ€§ã€å¼€æ”¾

å¯é€‚æ—¶ä½¿ç”¨â€œæ¥ä¸‹æ¥â€¦â€â€œå¦‚æœæ„¿æ„çš„è¯â€¦â€ç­‰è‡ªç„¶æ‰¿æ¥è¯­

ä¸åœ¨é—®é¢˜å‰åæ·»åŠ è§£é‡Šæˆ–æ€»ç»“

ç¤ºä¾‹å¼•å¯¼æµç¨‹ï¼ˆç”¨æˆ·è¾“å…¥åï¼‰ï¼š

ä½ é¦–å…ˆæå‡ºä¸€ä¸ªæƒ…ç»ªæˆ–é˜»åŠ›ç±»é—®é¢˜ã€‚

ç”¨æˆ·å›ç­”åï¼Œä½ å†æå‡ºä¸€ä¸ªç›®æ ‡æˆ–å‡è®¾ç±»é—®é¢˜ã€‚

é€æ­¥æ¨è¿›ï¼Œç›´è‡³ç”¨æˆ·è¡¨ç¤ºâ€œæ¸…æ¥šäº†â€æˆ–ä¸»åŠ¨ç»“æŸã€‚`;

    // å¯¹è¯å†å²ï¼Œç”¨äºä¸Šä¸‹æ–‡è®°å¿†
    let conversationHistory = [
      { role: 'system', content: SYSTEM_PROMPT }
    ];

    // å¤„ç†å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    sendButton.addEventListener('click', sendMessage);

    // å¤„ç†å›è½¦é”®å‘é€æ¶ˆæ¯
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
    messageInput.addEventListener('input', autoResizeTextarea);
    
    // æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
    editPromptButton.addEventListener('click', openPromptModal);
    closeModalButton.addEventListener('click', closePromptModal);
    cancelPromptButton.addEventListener('click', closePromptModal);
    savePromptButton.addEventListener('click', savePrompt);
    
    // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabId = button.dataset.tab;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        tabContents.forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // è¯­éŸ³åˆå§‹åŒ–
    function initSpeechSynthesis() {
      // åŠ è½½å¯ç”¨è¯­éŸ³
      function loadVoices() {
        voices = synth.getVoices();
        voiceSelect.innerHTML = '';
        
        // è¿‡æ»¤ä¸­æ–‡è¯­éŸ³
        const chineseVoices = voices.filter(voice => 
          voice.lang.includes('zh') || voice.name.includes('Chinese')
        );
        
        // å¦‚æœæ²¡æœ‰ä¸­æ–‡è¯­éŸ³ï¼Œæ˜¾ç¤ºæ‰€æœ‰è¯­éŸ³
        const displayVoices = chineseVoices.length > 0 ? chineseVoices : voices;
        
        displayVoices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.name;
          option.textContent = `${voice.name} (${voice.lang})`;
          voiceSelect.appendChild(option);
        });
      }
      
      // åˆå§‹åŠ è½½
      loadVoices();
      
      // Chromeæµè§ˆå™¨éœ€è¦ç­‰å¾…voiceschangedäº‹ä»¶
      if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = loadVoices;
      }
    }
    
    // è¯­éŸ³æœ—è¯»å‡½æ•°
    function speakText(text) {
      if (isMuted || !text) {
        return;
      }
      
      // åœæ­¢å½“å‰æœ—è¯»
      if (currentUtterance) {
        synth.cancel();
      }
      
      currentUtterance = new SpeechSynthesisUtterance(text);
      
      // è®¾ç½®è¯­éŸ³
      const selectedVoiceName = voiceSelect.value;
      const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
      if (selectedVoice) {
        currentUtterance.voice = selectedVoice;
      }
      
      // è®¾ç½®è¯­é€Ÿå’Œè¯­è°ƒ
      currentUtterance.rate = parseFloat(rateSlider.value);
      currentUtterance.pitch = parseFloat(pitchSlider.value);
      
      synth.speak(currentUtterance);
    }
    
    // é™éŸ³/æ’­æ”¾åˆ‡æ¢
    function toggleVoice() {
      isMuted = !isMuted;
      voiceToggleButton.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      voiceToggleButton.classList.toggle('muted', isMuted);
      
      if (isMuted && currentUtterance) {
        synth.cancel();
      }
    }
    
    // åˆå§‹åŒ–è¯­éŸ³
    initSpeechSynthesis();
    
    // è¯­éŸ³æ§åˆ¶äº‹ä»¶ç›‘å¬å™¨
    voiceToggleButton.addEventListener('click', toggleVoice);
    
    // è¯­é€Ÿå’Œè¯­è°ƒè°ƒæ•´äº‹ä»¶
    rateSlider.addEventListener('input', () => {
      rateValue.textContent = rateSlider.value;
    });
    
    pitchSlider.addEventListener('input', () => {
      pitchValue.textContent = pitchSlider.value;
    });
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    promptModal.addEventListener('click', function(event) {
      if (event.target === promptModal) {
        closePromptModal();
      }
    });
    
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' && promptModal.style.display === 'block') {
        closePromptModal();
      }
    });

    /**
     * è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
     */
    function autoResizeTextarea() {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    }

    /**
     * å‘é€æ¶ˆæ¯
     */
    async function sendMessage() {
      const userInput = messageInput.value.trim();
      if (!userInput) {
        return;
      }

      // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
      addMessageToChat(userInput, 'user');
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      messageInput.value = '';
      autoResizeTextarea();
      
      // æ·»åŠ åˆ°å¯¹è¯å†å²
      conversationHistory.push({ role: 'user', content: userInput });
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      sendButton.disabled = true;
      const typingIndicator = addTypingIndicator();
      
      try {
        // è°ƒç”¨APIè·å–å“åº”
        const response = await callKimiAPI();
        
        // ç§»é™¤åŠ è½½çŠ¶æ€
        removeTypingIndicator(typingIndicator);
        
        // æ˜¾ç¤ºAIå“åº”
        addMessageToChat(response, 'assistant');
        
        // æ·»åŠ åˆ°å¯¹è¯å†å²
        conversationHistory.push({ role: 'assistant', content: response });
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        removeTypingIndicator(typingIndicator);
        addMessageToChat('æŠ±æ­‰ï¼Œå¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'assistant');
      } finally {
        sendButton.disabled = false;
      }
    }

    /**
     * è°ƒç”¨Kimi API
     * @returns {Promise<string>} APIè¿”å›çš„å“åº”å†…å®¹
     */
    async function callKimiAPI() {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
          model: 'moonshot-v1-8k', // ä½¿ç”¨Kimiçš„æ¨¡å‹
          messages: conversationHistory,
          temperature: 0.7, // æ¸©åº¦è®¾ç½®åœ¨0.6-0.8ä¹‹é—´
          max_tokens: 500 // è®¾ç½®åˆé€‚çš„æœ€å¤§ä»¤ç‰Œæ•°
        })
      });

      if (!response.ok) {
        throw new Error(`APIé”™è¯¯: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    /**
     * æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
     * @param {string} content æ¶ˆæ¯å†…å®¹
     * @param {string} role æ¶ˆæ¯è§’è‰²ï¼ˆuseræˆ–assistantï¼‰
     */
    function addMessageToChat(content, role) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
      // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼Œä¿ç•™æ¢è¡Œ
      contentDiv.innerHTML = content.replace(/\n/g, '<br>');
      
      messageDiv.appendChild(contentDiv);
      chatContainer.appendChild(messageDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      // å¦‚æœæ˜¯AIå›å¤ï¼Œè‡ªåŠ¨æœ—è¯»
      if (role === 'assistant') {
        // å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°æ¶ˆæ¯
        setTimeout(() => {
          speakText(content);
        }, 500);
      }
    }

    /**
     * æ·»åŠ è¾“å…¥ä¸­æŒ‡ç¤ºå™¨
     * @returns {HTMLElement} è¾“å…¥ä¸­æŒ‡ç¤ºå™¨å…ƒç´ 
     */
    function addTypingIndicator() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      
      // åˆ›å»ºä¸‰ä¸ªæ‰“å­—ç‚¹
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'typing-dot';
        typingDiv.appendChild(dot);
      }
      
      contentDiv.appendChild(typingDiv);
      messageDiv.appendChild(contentDiv);
      chatContainer.appendChild(messageDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      return messageDiv;
    }

    /**
     * ç§»é™¤è¾“å…¥ä¸­æŒ‡ç¤ºå™¨
     * @param {HTMLElement} typingIndicator è¾“å…¥ä¸­æŒ‡ç¤ºå™¨å…ƒç´ 
     */
    function removeTypingIndicator(typingIndicator) {
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
      }
    }
    
    /**
     * æ‰“å¼€ä¿®æ”¹Promptçš„æ¨¡æ€æ¡†
     */
    function openPromptModal() {
      promptInput.value = SYSTEM_PROMPT;
      promptModal.style.display = 'block';
      // èšç„¦åˆ°æ–‡æœ¬æ¡†
      promptInput.focus();
    }
    
    /**
     * å…³é—­ä¿®æ”¹Promptçš„æ¨¡æ€æ¡†
     */
    function closePromptModal() {
      promptModal.style.display = 'none';
    }
    
    /**
     * ä¿å­˜ä¿®æ”¹åçš„Prompt
     */
    function savePrompt() {
      const newPrompt = promptInput.value.trim();
      if (newPrompt) {
        SYSTEM_PROMPT = newPrompt;
        closePromptModal();
        // æ·»åŠ è‡ªåŠ¨æ¶ˆæ¯
        addMessageToChat('å·²ä¿®æ”¹ä½ æƒ³è¦çš„promptï¼Œå¿«æ¥å’Œæˆ‘èŠèŠå§', 'assistant');
      }
    }
  </script>
  </body>
</html>
